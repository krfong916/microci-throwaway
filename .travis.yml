os: linux
language: node_js
node_js:
- node
cache: npm
jobs:
  include:
  # - stage: Test
  #   install: npm install
  #   name: Unit Test
  #   script: npm test
  - stage: Build
    name: Build Container Image
    services: docker
    script:
      # Authenticate to Docker Hub
      - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
      # Build and push image
      - docker-compose build   
      - docker tag microci-throwaway_server "$DOCKER_USERNAME"/microci-throwaway_server:latest
      - docker push "$DOCKER_USERNAME"/microci-throwaway_server
      - docker images
  - stage: Deploy(Staging)
    name: Deploy To Staging
    deploy:
      provider: script
      script:
        # Authenticate to Docker Hub and pull the latest image
        - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
        - docker pull "$DOCKER_USERNAME"/microci-throwaway_server:latest
        # Deploy image to Heroku
        - echo "${HEROKU_AUTH_TOKEN}" | docker login --username="$DOCKER_USERNAME" --password-stdin registry.heroku.com
        - docker tag "$DOCKER_USERNAME"/microci-throwaway_server registry.heroku.com/microci-test/web
        - echo "test container release"
        - heroku container:push web
        - heroku container:release web
        